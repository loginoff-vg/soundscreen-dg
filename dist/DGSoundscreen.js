DG.Soundscreen=DG.Handler.extend({options:{debug:!0},includes:DG.Mixin.Events,initialize:function(map,options){this._map=map,DG.Util.setOptions(this,options),this.tools=new DG.Soundscreen.Tools(this),this.settings=new DG.Soundscreen.Settings(this),this.ui=DG.Browser.touchEnabled||DG.Browser.mobile?new DG.Soundscreen.Sensor(this):new DG.Soundscreen.keyboard(this),this.geoservice=new DG.Soundscreen.Geoservice(map),this.position=new DG.Soundscreen.Position(map.getCenter(),{title:"Soundscreen"}),this.clicker=new DG.Soundscreen.Clicker(this),this.feeler=new DG.Soundscreen.Feeler(this),this.settingsControl=new DG.Soundscreen.SettingsControl(this),this.fire("info",{module:"Soundscreen",context:this,comment:"Init complete"})},addHooks:function(){this.clicker.enable(),this.position.addTo(this._map),this.ui.addTo(this._map),this.ui.setFocus(this.feeler)},removeHooks:function(){this.feeler.disable(),this.clicker.disable(),this.position.remove(),this.ui.remove()}}),DG.Soundscreen.log=window.log||function(){},DG.Soundscreen.Collection=DG.Handler.extend({_name:"",initialize:function(soundscreen,options){options=options||{},DG.Util.setOptions(this,options),this.soundscreen=soundscreen,this.ui=soundscreen.ui,this._actions=this.getActions(),this._name=options.name||this._name,this._caller=options.caller||"",this.setItems(options.data)},setItems:function(data){if(this.clear(),DG.Util.isArray(data)&&data.length){this._current=0;for(var i=0,len=data.length;len>i;i++)this.add(data[i]);this.sort()}return this},add:function(item){this._items.push(item)},clear:function(){this._items=[],this._current=-1},next:function(){return this._current=DG.Util.wrapNum(++this._current,[0,this._items.length]),this.get()},prev:function(){return this._current=DG.Util.wrapNum(--this._current,[0,this._items.length]),this.get()},get:function(index){return index=index||this._current,this._items[index]},sort:function(){this._items.sort()},status:function(){return this.ui.locale.t(this._name)+", "+this.ui.locale.t("list_view")+": "+this.ui.locale.t("n_item",this.size)},toString:function(){return this.status()},info:function(){return this.get()?this.get()+" "+this.current+" "+this.ui.locale.t("from")+" "+this.size:this.status()},view:function(e){e=e||{},"Up"==e.command&&this.prev(),"Down"==e.command&&this.next(),this.ui.out(this.info())},enter:function(e){var item=this.get();return item&&"function"==typeof item.open?item.open(this,e):void this.view()},back:function(){this._caller&&this.ui.setFocus(this._caller)||this.toRoot()},toRoot:function(){this.ui.setFocus(this.soundscreen.feeler)},explore:function(){var item=this.get();return item&&"function"==typeof item.expand?(this._successor=item.expand(),this._successor._caller=this,this.ui.setFocus(this._successor),this._successor):void this.view()},menu:function(){var item=this.get();return item&&"function"==typeof item.menu?item.menu():void 0},action:function(e){var fn=this._actions[e.key];return"function"==typeof fn?fn.call(this,e)||!0:!1},getActions:function(){return{Enter:this.enter,Backspace:this.toRoot,Space:this.view,ContextMenu:this.menu,Up:this.view,Down:this.view,Left:this.back,Right:this.explore}},addHooks:function(){this.ui.play("listview"),this.ui.status(this.status()),this.ui.out(this.status())},removeHooks:function(){}}),Object.defineProperty(DG.Soundscreen.Collection.prototype,"size",{get:function(){return this._items.length}}),Object.defineProperty(DG.Soundscreen.Collection.prototype,"current",{get:function(){return this._current+1},set:function(v){v--,this._current=0>v?0:v>this.size?this.size:v}}),DG.Soundscreen.CollectionItem=DG.Class.extend({initialize:function(soundscreen,options){this.soundscreen=soundscreen,this.locale=new DG.Soundscreen.Locale(soundscreen._map),this.options=options||{},this.name=this.options.name||"",this.data=this.options.data,this.data&&this.data.name&&(this.name=this.data.name)},expand:function(caller,data){if(caller=caller||null,data=data||this.data,"object"==typeof data){var items=DG.Soundscreen.tools.objectMap(data,{callback:function(key){return new DG.Soundscreen.CollectionItem(this.soundscreen,{parent:this,name:key,data:data[key]})}.bind(this)});return new DG.Soundscreen.Collection(this.soundscreen,{parent:this,caller:caller,name:this.name,data:items})}return""},menu:function(){},info:function(){return"object"==typeof this.data?this.name:this.name+": "+this.data},toString:function(){return this.info()}}),DG.Soundscreen.Control=DG.Class.extend({options:{name:"noname",value:"",config:{}},initialize:function(soundscreen,options){options=options||{},DG.Util.setOptions(this,options),this.soundscreen=soundscreen,this.ui=soundscreen.ui,this.locale=new DG.Soundscreen.Locale(soundscreen._map)},open:function(){return this.disabled?this.ui.out(this.toString()):(this.selectSetup(),void this.ui.setFocus(this.select))},selectSetup:function(){if(this.select)return this.select;this.select=new DG.Soundscreen.Control.Select(this.soundscreen,{name:this.name(),value:this.options.value,caller:this.options.parent,parent:this});var values=[],config=this.options.config||{};switch(config.type){case"range":values=DG.Soundscreen.tools.createRange(config.min,config.max,config.step);break;case"set":this.select.multiple=!0,values=config.values;break;case"enum":values=config.values;break;default:values=[!1,!0]}values.forEach(function(item,i){var option=new DG.Soundscreen.MenuItem(this.soundscreen,{name:item.toString(),value:item}),value=this.options.value.toString();(value==item||-1!==value.indexOf(item))&&(option.checked=!0,this.select._current=i),this.select.add(option)},this)},_onchange:function(value){this.options.value=value,"function"==typeof this.options.onchange&&this.options.onchange({value:value,control:this}),this.options.config&&"function"==typeof this.options.config.onchange&&this.options.config.onchange(value,this)},value:function(){return"set"==this.options.config.type?this.options.value.split(",").map(function(item){return this.locale.t(item)},this).join(","):this.locale.t(this.options.value)},name:function(){return this.options.config.label||this.options.name},info:function(){return this.locale.t(this.name())+": "+this.value()},toString:function(){var disabled=this.options.disabled?this.locale.t("disabled"):"";return this.info()+" "+disabled}}),DG.Soundscreen.Control.Select=DG.Soundscreen.Collection.extend({check:function(){var item=this.get();if(this.multiple)item.checked=!item.checked,this.options.value=this.checked().map(function(item){return item.value}).join(",");else{if(item.checked)return;this._items.forEach(function(item){item.checked=!1}),item.checked=!0,this.options.value=item.value}this.options.parent&&this.options.parent._onchange&&"function"==typeof this.options.parent._onchange&&this.options.parent._onchange(this.options.value)},checked:function(){return this._items.filter(function(item){return item.checked})},info:function(){return this.get()?this.get()+" "+this.current+" "+this.ui.locale.t("from")+" "+this.size:this.status()},status:function(){return this.ui.locale.t(this._name)+", "+this.ui.locale.t("choise_value")+": "+this.ui.locale.t("n_item",this.size)},enter:function(){this.check(),this.view()},explore:function(){this.enter()},addHooks:function(){this.ui.play("listview"),this.ui.status(this.status()),this.ui.out(this.status()),this.ui.out(this.info(),2)},removeHooks:function(){}}),DG.Soundscreen.DataStorage=DG.Class.extend({options:{},get:function(path){return path&&"string"==typeof path?path.split(".").reduce(function(m,i){return m&&"object"==typeof m?m[i]:null},this.options):null},set:function(path,source){if("object"==typeof path)return DG.setOptions(this,path);var route=this._getRoute(path);if(!route)return null;if("*"==route.prop&&"object"==typeof source){for(var k in route.dest)this._setProp(route.dest,k,source);return route.dest}return this._setProp(route.dest,route.prop,source)},_setProp:function(dest,prop,source){return dest[prop]&&"object"==typeof dest[prop]&&"object"==typeof source?DG.extend(dest[prop],source):dest[prop]=source,dest[prop]},_getRoute:function(path){if(path&&"string"==typeof path){path=("options."+path).split(".");var prop=path.pop(),parent=path.reduce(function(m,i){return m&&"object"==typeof m?m[i]:null},this);return parent&&"object"==typeof parent?{dest:parent,prop:prop}:void 0}},each:function(fn,cont,path){cont=cont||this.options,path=path||"";for(var k in cont){var res=fn(cont[k],k,path);"continue"!=res&&cont[k]&&"object"==typeof cont[k]&&this.each(fn,cont[k],path?path+"."+k:k)}}}),DG.Soundscreen.Firm=DG.Soundscreen.CollectionItem.extend({getFirmInfo:function(){return this._loaded?this._loaded:this._loaded=this.soundscreen.geoservice.getFirmInfo(this.data.id)},open:function(caller){caller&&this.getFirmInfo().then(function(data){DG.extend(this.data,data.result.items[0]),caller._successor=this.expand(caller),caller.ui.setFocus(caller._successor)}.bind(this))["catch"](function(){caller._successor=new DG.Soundscreen.Collection(this.soundscreen,{caller:caller,parent:this,name:"Информация об организации "+this.name}),caller.ui.setFocus(caller._successor)}.bind(this))},click:function(){this.soundscreen._map.fire("click",{latlng:this.coords[0],emitter:this})}}),DG.Soundscreen.Menu=DG.Soundscreen.Collection.extend({addItems:function(data){if(data&&"object"==typeof data){var items=DG.Soundscreen.tools.objectMap(data,{callback:function(key){return new DG.Soundscreen.MenuItem(this.soundscreen,{parent:this,name:key,open:data[key]})}.bind(this)});this.setItems(items)}},sort:function(){},info:function(){return this.get()?this.get()+" "+this.current+" "+this.ui.locale.t("from")+" "+this.size:this.status()},status:function(){return this.ui.locale.t(this._name)+", "+this.ui.locale.t("menu")+": "+this.ui.locale.t("n_item",this.size)},enter:function(e){var item=this.get();return item&&"function"==typeof item.open?item.open(this,e):void this.view()},explore:function(){this.view()},addHooks:function(){this.ui.play("listview"),this.ui.status(this.status()),this.ui.out(this.status()),this.ui.out(this.info(),2)},removeHooks:function(){}}),DG.Soundscreen.MenuItem=DG.Class.extend({initialize:function(soundscreen,options){this.soundscreen=soundscreen,this.locale=new DG.Soundscreen.Locale(soundscreen._map),options=options||{},DG.Util.setOptions(this,options),this.name=options.name||"noname",this.name=this.locale.t(this.name),this.open=options.open||this.open,this.value=options.value},open:function(){},info:function(){return this.name},toString:function(){var checked=this.checked?this.locale.t("checked"):"";return this.info()+" "+checked}}),DG.Soundscreen.Geounit=DG.Soundscreen.CollectionItem.extend({initialize:function(soundscreen,data){this.soundscreen=soundscreen,this._map=soundscreen._map,this.locale=new DG.Soundscreen.Locale(this._map),this._settings=soundscreen.settings.get("geodata")||{azimuthFormat:"degrees"},this.position=this.soundscreen.position,this.data=data,this.name=data.building_name||data.name||data.full_name||data.purpose_name||"no name",data.geometry&&data.geometry.selection&&(this.coords=DG.Wkt.toLatLngs(data.geometry.selection)),this.publicData={name:this.name},data.floors&&data.floors.ground_count&&(this.floors=data.floors.ground_count)},closest:function(){return this.coords?this.coords[0]:null},azimuth:function(){return this.coords&&this.position?this.soundscreen.tools.azimuth(this.position.get(),this.closest()):""},distance:function(){return this.coords&&this.position?DG.Util.formatNum(this.position.get().distanceTo(this.closest()),0):""},info:function(){var underCursor=this.underCursor?" "+this.locale.t("under_cursor"):"";return[this.name+underCursor,this.locale.t("to_the")+this.locale.formatAzimuth(this.azimuth(),this._settings.azimuthFormat),this.locale.formatDistance(this.distance())].join(", ")},toString:function(){return this.info()},positionBy:function(){this.coords&&this.position&&this.position.set(this.coords[0])},click:function(){this.soundscreen._map.fire("click",{latlng:this.coords[0],emitter:this})}}),DG.Soundscreen.Geounit.Building=DG.Soundscreen.Geounit.extend({getFirms:function(){return this._firms?this._firms:this._firms=this.soundscreen.geoservice.request("firmsInHouse",{houseId:this.data.id})},open:function(caller){caller&&this.getFirms().then(function(data){var items=data.map(function(item){return new DG.Soundscreen.Firm(this.soundscreen,{parent:this,data:item})}.bind(this));caller._successor=new DG.Soundscreen.Collection(this.soundscreen,{caller:caller,parent:this,name:"organisation",data:items}),caller.ui.setFocus(caller._successor)}.bind(this))["catch"](function(){caller._successor=new DG.Soundscreen.Collection(this.soundscreen,{caller:caller,parent:this,name:"organisation"}),caller.ui.setFocus(caller._successor)}.bind(this))},click:function(){this.soundscreen._map.fire("click",{latlng:this.coords[0],emitter:this})}}),DG.Soundscreen.Geounit.Street=DG.Soundscreen.Geounit.extend({getSegments:function(){if(this._segments)return this._segments;if(this._segments=[],!this.coords||this.coords.length<2)return this._segments;for(var i=1,len=this.coords.length;len>i;i++)this._segments.push({begin:this.coords[i-1],end:this.coords[i],size:this.coords[i].distanceTo(this.coords[i-1]),azimuth:this.soundscreen.tools.azimuth(this.coords[i-1],this.coords[i])});return this._segments},length:function(){return this._streetLength?this._streetLength:this._streetLength=this.getSegments().reduce(function(memo,item){return memo+item.size},0)},closest:function(){if(this._closest)return this._closest;var point=this._map.project(this.position.get());return this._segment=this.getSegments().reduce(function(memo,item,i){return item.beginP=this._map.project(item.begin),item.endP=this._map.project(item.end),item.distance=DG.LineUtil.pointToSegmentDistance(point,item.beginP,item.endP),!memo.distance||item.distance<memo.distance?(this._segmentIndex=i,item):memo}.bind(this),{}),this._closest=this._segment?this._map.unproject(DG.LineUtil.closestPointOnSegment(point,this._segment.beginP,this._segment.endP)):this.coords[0]},open:function(caller){caller&&(caller._successor=this.expand(caller,{length:this.length(),segments:this.getSegments()}),caller.ui.setFocus(caller._successor))},click:function(){this.soundscreen._map.fire("click",{latlng:this.coords[0],emitter:this})}}),DG.Soundscreen.UnitsCollection=DG.Soundscreen.Collection.extend({_name:"environs",update:function(){var types=this.soundscreen.settings.get("geodata.requestGeounits")||"building",params={point:this.soundscreen.position.get("geoquery"),type:types,radius:this.soundscreen.settings.get("geodata.radius")},self=this;return new Promise(function(res,rej){self.soundscreen.geoservice.request("locate",params).then(function(data){self.setItems(data),res(self)})["catch"](function(err){self.clear(),rej(err)})})},sort:function(field){field=field||this.soundscreen.settings.get("geodata.sortOrder")||"info",this._items.sort(function(a,b){return a[field]()-b[field]()})},add:function(data){if(data&&data.type){var type=data.type[0].toUpperCase()+data.type.slice(1);this._items.push("function"==typeof DG.Soundscreen.Geounit[type]?new DG.Soundscreen.Geounit[type](this.soundscreen,data):new DG.Soundscreen.Geounit(this.soundscreen,data))}},enter:function(e){var item=this.get();return item?e.mode.Ctrl&&"function"==typeof item.click?item.click():e.mode.Shift&&"function"==typeof item.positionBy?(item.positionBy(),this.back()):"function"==typeof item.open?item.open(this):void this.view():this.view()}}),DG.Soundscreen.Clicker=DG.Handler.extend({initialize:function(soundscreen,onclick){this._map=soundscreen._map,this.ui=soundscreen.ui,this.locale=new DG.Soundscreen.Locale(this._map),this.onclick=onclick||function(data){this.ui.out(data,2)}.bind(this),this._map.geoclicker||(DG.Util.setOptions(this._map,{geoclicker:{showRouteSearch:!0}}),this._map.addHandler("geoclicker",DG.Geoclicker)),this._origGeoclickerhandleResponse=this._map.geoclicker._controller.handleResponse,this._map.geoclicker.enable()},addHooks:function(){this._map.on(this._mapEvents(),this),this._map.once("popupopen",function(){this.ui.out("Открыто окно с информацией 2ГИС. Для просмотра 2 раза нажмите Tab.",1)},this),this._map.geoclicker._controller.handleResponse=this._render.bind(this)},removeHooks:function(){this._map.off(this._mapEvents(),this),this._map.geoclicker._controller.handleResponse=this._origGeoclickerhandleResponse},_render:function(result){this.onclick(this.parse(result)),this._origGeoclickerhandleResponse.call(this._map.geoclicker._controller,result)},_mapEvents:function(){return{popupopen:this.onpopupopen,popupclose:this.onpopupclose}},onpopupopen:function(e){e.popup.on("contentupdate",this.onpopupupdate,this)},onpopupclose:function(e){e.popup.off("contentupdate",this.onpopupupdate,this),this.ui.play("popupclose"),this.ui._input.focus()},onpopupupdate:function(){this.ui.play("popupopen")},parse:function(result){var txt=this.locale.t("no_data"),list=[];if(!result||"string"==typeof result)return result||txt;for(var key in result){var i=result[key];txt=i.name,txt||(txt=i.reference?i.reference.name:"noname"),list.push(txt)}return txt=list.reverse().join(", ")}}),DG.Soundscreen.Feeler=DG.Handler.extend({initialize:function(soundscreen){this.soundscreen=soundscreen,this._map=soundscreen._map,this.project=this._map.projectDetector.getProject(),this.ui=soundscreen.ui,this.position=soundscreen.position,this.environs=new DG.Soundscreen.UnitsCollection(soundscreen),this.menuSetup(),this.locale=new DG.Soundscreen.Locale(this._map),this._name="map_view",this._actions=this.getActions()},mapSize:function(){var b=this._map.getBounds();return{hight:b.getNorthEast().distanceTo(b.getSouthEast()),width:b.getSouthWest().distanceTo(b.getSouthEast())}},getStatus:function(){return this._status},setStatus:function(){return this._status=[this.locale.t(this._name),this.locale.t("step")+this.locale.formatDistance(this.getStep()),this.locale.t("zoom")+this._map.getZoom()].join(", ")},sayStatus:function(){this.ui.out(this._status)},repeat:function(){this.ui.out()},autoStep:function(){var zoom=-1*(this._map.getZoom()-21),digits=Math.floor(zoom/3),base=zoom%3*2.5;return Math.pow(10,digits)*(0==base?1:base)},setStep:function(value){value||(value=this.autoStep()),this._step=value},getStep:function(){return this._step||50},update:function(){this.setStep(),this.ui.status(this.setStatus()),this.sayStatus()},centering:function(e){e.mode.Ctrl?this.position.centerBy():this.position.toCenter()},move:function(e){var step=e.mode.Shift?this.getStep()/5:this.getStep();this.position.move(e.key,step,e.mode.Ctrl)},zoom:function(e){e=e||{mode:{}};var pr=this.project||{minZoom:5,maxZoom:18},z=this._map.getZoom(),x=e.mode.Shift?pr.minZoom:pr.maxZoom;return z==x?void this.ui.play("restrict").then(function(){this.sayStatus()}.bind(this)):(e.mode.Shift?z--:z++,void this._map.setZoomAround(this.position.get(),z,{animate:!1}))},enter:function(e){return e.mode.Ctrl?void this.position.click():void this.ui.setFocus(this.environs)},menu:function(){this.ui.setFocus(this._menu)},action:function(e){var fn=this._actions[e.key];return this.enable()&&"function"==typeof fn?fn.call(this,e)||!0:!1},getActions:function(){return{C:this.centering,S:this.sayStatus,Z:this.zoom,Up:this.move,Down:this.move,Left:this.move,Right:this.move,Enter:this.enter,Space:this.repeat,ContextMenu:this.menu}},getMenuActions:function(){return{centerBy:function(){this.position.centerBy(),this.ui.setFocus(this)}.bind(this),toCenter:function(){this.position.toCenter(),this.ui.setFocus(this)}.bind(this),zoomIn:function(c,e){this.zoom(),e.mode.Ctrl?this.ui.setFocus(this):this.update()}.bind(this),zoomOut:function(c,e){e.mode.Shift=!0,this.zoom(e),e.mode.Ctrl?this.ui.setFocus(this):this.update()}.bind(this),settings:function(){this.soundscreen.settingsControl.focus(this)}.bind(this)}},menuSetup:function(){this._menu=new DG.Soundscreen.Menu(this.soundscreen,{caller:this}),this._menu.addItems(this.getMenuActions())},caseOverUnit:function(collection,data){var types=this.soundscreen.settings.get("geodata.requestGeounits"),found=types.split(",").filter(function(t){return t in data});if(!found[0])return!1;this.ui.play("mapview");for(var id=data[found[0]].id,i=0,len=collection.size;len>i;i++)if(collection._items[i].data.id==id)return collection._items[i].underCursor=!0,collection._items[i]},research:function(e){this.soundscreen.geoservice.getLocations({latlng:this.position.get(),zoom:16}).then(function(data){var label=this.soundscreen.clicker.parse(data);this.position.title(label),this.environs.update().then(function(res){var unit=this.caseOverUnit(res,data)||res.get();this.ui.out(unit),"add"==e.type&&this.ui.out(this.getStatus(),1)}.bind(this))["catch"](function(err){DG.Soundscreen.bug(err),this.ui.out(label),this.ui.out(this.environs.status(),2)}.bind(this))}.bind(this))["catch"](function(){var txt=this.locale.t("no_data");this.ui.out(txt),this.position.title(txt)}.bind(this))},_positionEvents:{restrict:function(){this.ui.play("bound")["catch"](function(){this.out(this.locale.t("map_bound"),!0)}.bind(this.ui))},move:function(e){this.research(e),this.ui.play("pass")},add:function(e){this.research(e)}},onprojectchange:function(e){this.project=e.getProject(),this.ui.play("sputnik"),this.project&&this.ui.out(this.ui.locale.t("project_change")+this.project.code,1)},onprojectleave:function(){this.project&&this.ui.out(this.ui.locale.t("project_leave")+this.project.code,1)},_mapEvents:function(){return{zoomend:this.update,projectleave:this.onprojectleave,projectchange:this.onprojectchange}},addHooks:function(){this.ui.play("success"),this.setStep(),this.ui.status(this.setStatus()),this._map.on(this._mapEvents(),this),this.position.on(this._positionEvents,this).fire("add")},removeHooks:function(){this.position.off(this._positionEvents,this),this._map.off(this._mapEvents(),this)}}),DG.Soundscreen.Position=DG.Marker.extend({_zoomAnimated:!1,set:function(value){return this.setLatLng(value)},get:function(format){if(!format)return this._latlng.clone();var position=[this._latlng.lat,this._latlng.lng];switch(format){case"array":return position;case"string":return position.join(",");case"geoquery":return position.reverse().join(",");default:return this._latlng.clone()}},title:function(message){this._icon.title=message},toCenter:function(){return this._next=this._map.getCenter(),this.setLatLng(this._map.getCenter())},centerBy:function(){return this._next=this.get(),this._map.setView(this.get(),this._map.getZoom(),{animate:!1})},checkBounds:function(latlng){return this._map.getBounds().contains(latlng)},move:function(dir,step,noRestrict){if(this._next=this.get().toSide(dir,step),!this.checkBounds(this._next)){if(!noRestrict)return this.fire("restrict",{latlng:this._next}),this._next=this.get(),!1;this.moveMap(dir)}return this.set(this._next)},moveMap:function(dir){var step,b=this._map.getBounds();step=b.getNorthWest().distanceTo("Left"==dir||"Right"==dir?b.getNorthEast():b.getSouthWest());var newCenter=this._map.getCenter().toSide(dir,step);this._map.setView(newCenter,this._map.getZoom(),{animate:!1})},getEvents:function(){return{zoom:this.update,viewreset:this.update,zoomend:this.visibleControl,moveend:this.visibleControl}},visibleControl:function(e){"moveend"!=e.type||this.checkBounds(this._next)||this.toCenter(),"zoomend"!=e.type||this.checkBounds(this.get())||this._zoom!==this._map.getZoom()&&this.centerBy(),this._zoom=this._map.getZoom()},click:function(){this._map.fire("click",{latlng:this.get()})},onAdd:function(){DG.Marker.prototype.onAdd.apply(this,arguments),this._next=this.get(),this._zoom=this._mapToAdd.getZoom(),this.on("click",this.click,this)},onRemove:function(){DG.Marker.prototype.onRemove.apply(this,arguments),this.off("click",this.click,this)}}),DG.Soundscreen.Geoservice=DG.Geoclicker.Provider.CatalogApi.extend({firmsInHouse:function(parameters){parameters=parameters||{};var params={building_id:parameters.houseId,page:parameters.page||1};return this._performRequest(params,this._urlFirmsInHouse)},locate:function(params){return params=params||{},params.point=params.point||this._map.soundscreen.position.get("geoquery"),params.type=params.type||"building",params.radius=params.radius||100,params.zoom_level=params.zoom||16,params.fields=this._geoFields,this._performRequest(params,this._urlGeoSearch)},request:function(reqname,params){var self=this;return new Promise(function(resolve,reject){function onload(response){if(self._isNotFound(response)){var err=new Error("no data");err.code=response.meta?response.meta.code:null,reject(err)}var data=response.result.items;loaded+=data.length,loaded<response.result.total&&(params.page++,fn(params).then(onload)["catch"](reject));for(var i=0,len=data.length;len>i;i++)items.push(data[i]);response.result.total==loaded&&resolve(items)}self[reqname]&&params||reject(new Error("Invalid arguments")),params.page=1;var items=[],loaded=0,fn=self[reqname].bind(self);fn(params).then(onload)["catch"](reject)})}}),DG.Soundscreen.Locale=function(map){return DG.Soundscreen.Locale._instance?DG.Soundscreen.Locale._instance:(this._map=map,void(DG.Soundscreen.Locale._instance=this))},DG.Soundscreen.Locale.prototype=DG.extend({constructor:DG.Soundscreen.Locale,formatDistance:function(d){return d>1e3?this.t("n_km",d/1e3)+this.t("n_m",d%1e3):this.t("n_m",d)},formatAzimuth:function(value,measure){switch(measure){case"degrees":return value=(value/Math.PI*180).toFixed(0),0>value?(value*=-1,"-"+this.t("n_g",value)):this.t("n_g",value);case"clock":return this.t("n_h",DG.Util.wrapNum((value/Math.PI*6).toFixed(0),[0,12]));case"windrose":var i=DG.Util.wrapNum((value/Math.PI*4).toFixed(0),[0,8]);return this.t(this.windrose[i]);default:return value}},windrose:["North","Northeast","East","Southeast","South","Southwest","West","Northwest"]},DG.Locale),DG.Soundscreen.Locale.Dictionary={},DG.Soundscreen.Audio=DG.Class.extend({options:{sourceDir:"",sourceFile:"DGSoundscreenAudioLibrary.json",format:"",playback:{loop:!1,volume:1,position:[0,0,0],panner:{distanceModel:"linear",maxDistance:1e3,rolloffFactor:1}}},_loaded:{},initialize:function(options){DG.Util.setOptions(this,options),this.getContext(),-1!==this.options.sourceFile.indexOf(".json")&&(this._asyncLibrary=this.loadLibrary(this.options.sourceFile))},getContext:function(){if(void 0===this._ac){var AudioContext=window.AudioContext||window.webkitAudioContext;this._ac=AudioContext?new AudioContext:null}return this._ac},load:function(id){var self=this;return new Promise(function(resolve,reject){self._asyncLibrary?self._asyncLibrary.then(function(res){id in res?self.audioBufferFromBase64(res[id]).then(resolve,reject):self.loadFile(id).then(resolve,reject)},reject):self.loadFile(id).then(resolve,reject)})},loadFile:function(id){var self=this,url=this.options.sourceDir+id+this.options.format;return new Promise(function(resolve,reject){self.audioBufferFromURL(url).then(resolve,reject)})},loadLibrary:function(url){return new Promise(function(resolve,reject){DG.Soundscreen.tools.httpGet(url).then(function(res){try{res=JSON.parse(res)}catch(err){reject(err)}resolve(res)},reject)})},play:function(id,options){return this._loaded[id]||(this._loaded[id]=this.load(id)),this._loaded[id].then(function(result){return this.playBuffer(result,options)}.bind(this))},playBuffer:function(buffer,options){if(!this._ac)return Promise.reject(new TypeError("Invalid AudioContext."));if(!(buffer&&buffer instanceof AudioBuffer))return Promise.reject(new TypeError("Invalid AudioBuffer."));try{options=Object.assign({},this.options.playback,options);var source=this._ac.createBufferSource(),gain=this._ac.createGain(),panner=this._ac.createPanner();return Object.assign(panner,options.panner),source.connect(gain),gain.connect(panner),panner.connect(this._ac.destination),source.loop=options.loop,gain.gain.value=options.volume,panner.setPosition.apply(panner,options.position),this.status="playing",source.buffer=buffer,source.start(),options.onended&&options.onended.call&&(source.onended=options.onended),Promise.resolve(source)}catch(err){return Promise.reject(err)}},decode:function(audioData,context){var self=this;return new Promise(function(resolve,reject){context&&(resolve=resolve.bind(context),reject=reject.bind(context)),self._ac||reject(new Error("AudioContext not supported.")),self._ac.decodeAudioData(audioData,resolve,reject)})},_arrayBufferToBase64:function(buffer){for(var bytes=new window.Uint8Array(buffer),len=buffer.byteLength,binary="",i=0;len>i;i++)binary+=String.fromCharCode(bytes[i]);return window.btoa(binary)},_base64ToArrayBuffer:function(buffer){var binary=window.atob(buffer);buffer=new window.ArrayBuffer(binary.length);for(var bytes=new window.Uint8Array(buffer),i=0;i<buffer.byteLength;i++)bytes[i]=255&binary.charCodeAt(i);return buffer},audioBufferFromBase64:function(data){return this.decode(this._base64ToArrayBuffer(data))},audioBufferFromURL:function(url){return DG.Soundscreen.tools.httpGet(url,"arraybuffer").then(this.decode.bind(this))},base64FromURL:function(url){return DG.Soundscreen.tools.httpGet(url,"arraybuffer").then(this._arrayBufferToBase64)}}),DG.Soundscreen.Tools=DG.Class.extend({initialize:function(soundscreen){this._map=soundscreen._map},azimuth:function(begin,end){return this._map.project(begin).azimuthTo(this._map.project(end))}}),DG.Soundscreen.tools={httpGet:function(url,type){return new Promise(function(resolve,reject){var request=new XMLHttpRequest;request.open("GET",url,!0),type&&(request.responseType=type),request.onload=function(){if(200==this.status)resolve(this.response);else{var error=new Error(this.statusText);error.code=this.status,error.url=url,reject(error)}},request.onerror=function(){var error=new Error(this.statusText);error.code=this.status,error.url=url,reject(error)},request.send()})},objectMap:function(o,options){options=options||{};var keys=options.own?Object.getOwnPropertyNames(o):Object.keys(o);return keys.map(options.callback||function(k){return k+": "+o[k]})},createRange:function(min,max,step){min=min||0,max=max||10,step=step||1;var presigion=(""+step%1).length-2;0>presigion&&(presigion=0);for(var result=[],i=min;max>=i;i+=step)result.push(+DG.Util.formatNum(i,presigion));return result}},DG.Point.prototype.azimuthTo=function(point){var delta=DG.point(point).subtract(this);return Math.atan2(delta.x,-delta.y)},DG.LatLng.prototype.toSide=function(direction,distance){if(!distance)return this.clone();var b=this.toBounds(2*distance),lat=this.lat,lng=this.lng;switch(direction){case"West":case"Left":lng=b.getWest();break;case"North":case"Up":lat=b.getNorth();break;case"East":case"Right":lng=b.getEast();break;case"South":case"Down":lat=b.getSouth()}return new DG.LatLng(lat,lng)},function(){function getNativeSynth(){if(!window.speechSynthesis||!SpeechSynthesisEvent)return null;var native=window.speechSynthesis,synth={_error:null,_voice:null,langMap:{ar:"ar-SA",cs:"cs-CZ",en:"en-US",es:"es-ES",it:"it-IT",ru:"ru-RU"},speak:function(msg,options){var frase=new window.SpeechSynthesisUtterance(msg);return frase.voice=this._voice,options&&DG.extend(frase,options),native.speak(frase),frase},setVoice:function(lang){return this._voice=this.getVoice(lang)},getVoice:function(lang){return this._voices||(this._voices=this.getVoices()),lang&&2==lang.length&&(lang=this.langMap[lang]),this._voices[lang]||null},getVoices:function(){return native.getVoices().reduce(function(memo,item){return memo[item.lang]=item,memo},{})},isPlaying:function(){return native.speaking||native.paused||native.pending},cancel:native.cancel.bind(native)};return native.onvoiceschanged=function(){synth._voices=synth.getVoices()},synth}DG.Soundscreen.getTTS=function(soundscreen){return DG.Soundscreen.tts?DG.Soundscreen.tts:DG.Soundscreen.tts=new TTS(soundscreen)};var TTS=DG.Handler.extend({initialize:function(soundscreen){this.soundscreen=soundscreen,this.engine=getNativeSynth(),this.engine?(soundscreen.settings.config.set("tts.enable.onchange",this.toggle.bind(this)),this._settings=soundscreen.settings.get("tts")):(soundscreen.settings.set("tts.enable",!1),
soundscreen.settings.config.set("tts.*",{disabled:!0}))},addHooks:function(){this.setLang(),this.soundscreen._map.on("langchange",this.setLang,this)},removeHooks:function(){this.soundscreen._map.off("langchange",this.setLang,this)},toggle:function(value){value?this.enable():this.disable()},canSpeak:function(){return this.engine&&this.engine._voice},cancel:function(){this.engine&&this.engine.isPlaying()&&this.engine.cancel()},say:function(msg,priority){return this._settings.enable&&this.canSpeak()&&this.enabled()?(priority=priority||0,this.engine.isPlaying()&&(priority||1===this._fraze.priority?this._fraze.addEventListener("ended",this.say.bind(this,msg,priority)):this.engine.cancel()),this._fraze=this.engine.speak(msg,this._settings),this._fraze.priority=priority,this._fraze):!1},setLang:function(lang){return this.engine?(lang=lang||this.soundscreen._map.getLang(),this.engine.setVoice(lang)):void 0}})}(),DG.Soundscreen.Config=DG.Soundscreen.DataStorage.extend({options:{},each:function(fn,cont,path){cont=cont||this.options,path=path||"";for(var k in cont){var prop=cont[k];"object"==typeof prop&&("type"in prop?fn(prop,k,path):this.each(fn,prop,path?path+"."+k:k))}}}),DG.Soundscreen.Config.mergeOptions({geodata:{radius:{label:"radius",type:"range",min:50,max:200,step:50,"default":100},azimuthFormat:{label:"azimuth_format",type:"enum",values:["windrose","degrees","clock"],"default":"windrose"},sortOrder:{label:"sort_order",type:"enum",values:["distance","azimuth","name"],"default":"distance"},requestGeounits:{label:"include_in_request",type:"set",values:["attraction","building","street"],"default":"attraction,building,street"}},tts:{enable:{type:"Boolean","default":!0},volume:{label:"volume",type:"range",min:.1,max:1,step:.1,"default":1},pitch:{label:"pitch",type:"range",min:0,max:2,step:.1,"default":1},rate:{label:"rate",type:"range",min:1,max:3,step:.1,"default":1.5}}}),DG.Soundscreen.Settings=DG.Soundscreen.DataStorage.extend({options:{},initialize:function(soundscreen){this.soundscreen=soundscreen,this.config=new DG.Soundscreen.Config,this.restore(),this.setDefaults(),window.addEventListener("beforeunload",this.store.bind(this))},getDefault:function(option){var config="object"==typeof option?option:this.config.get(option);return config&&void 0!==config["default"]?config["default"]:""},setDefaults:function(rewrite){this.config.each(function(option,id,path){var value=this.get(path+"."+id);this.get(path)||this.set(path,{}),(rewrite||void 0===value||null===value)&&this.set(path+"."+id,this.getDefault(option))}.bind(this))},storageSupported:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},store:function(){this.storageSupported()&&localStorage.setItem("soundscreenSettings",JSON.stringify(this.options))},restore:function(){if(!this.storageSupported())return null;try{return DG.Util.setOptions(this,JSON.parse(localStorage.getItem("soundscreenSettings")))}catch(err){return null}}}),DG.Soundscreen.SettingsControl=DG.Class.extend({initialize:function(soundscreen){this.soundscreen=soundscreen,this._map=soundscreen._map,this.locale=new DG.Soundscreen.Locale(soundscreen._map),this.settings=soundscreen.settings,this.config=soundscreen.settings.config},focus:function(caller){this.soundscreen.ui.setFocus(this.getMenu(caller))},getMenu:function(caller){if(!this._menu){this._menu=new DG.Soundscreen.Menu(this.soundscreen,{name:"settings"});var actions={};for(var k in this.config.options)actions[k]=this.groupView.bind(this,k);this._menu.addItems(actions)}return caller&&(this._menu._caller=caller),this._menu},groupView:function(groupId){var group=this.config.get(groupId);if(group){var collection=new DG.Soundscreen.Menu(this.soundscreen,{name:groupId,caller:this._menu});for(var k in group)collection.add(new DG.Soundscreen.Control(this.soundscreen,{parent:collection,name:k,value:this.settings.get(groupId+"."+k),path:groupId+"."+k,config:group[k],onchange:this.onChange.bind(this)}));this.soundscreen.ui.setFocus(collection)}},onChange:function(e){this.settings.set(e.control.options.path,e.value)}}),DG.Soundscreen.UI=DG.Layer.extend({initialize:function(soundscreen){if(this._map=soundscreen._map,this._lastOut="",this.locale=new DG.Soundscreen.Locale(soundscreen._map),this.handler=this,this._prevHandler=this,soundscreen.options.audio){var player=new DG.Soundscreen.Audio(soundscreen.options.audio);this.play=player.play.bind(player)}else this.play=function(){return Promise.reject(new Error("Audio is not ready"))};this.tts=DG.Soundscreen.getTTS(soundscreen)},action:function(e){return this.out(e.command+", "+e.code)},setFocus:function(handler){return handler&&handler.action?(this.handler.disable&&this.handler.disable(),handler.enable&&handler.enable(),this._prevHandler=this.handler,this.handler=handler,this):!1},_setup:function(){},_bforeRemove:function(){},_events:function(){return{}},onInput:function(e){var processed=!1;try{processed=this.handler.action(e)}catch(err){this.soundscreen.fire("error",DG.Util.extend(err,{module:"UI",context:this,args:arguments,comment:"ui: bad handler"})),this.setFocus(this._prevHandler)}return processed||this.fire("input",e),processed},onAdd:function(){this.tts.enable(),this._container=DG.DomUtil.create("div","soundscreen-ui",this.getPane()),this._setup(),this._display||(this._display=DG.DomUtil.create("div","soundscreen-ui-display",this._container)),this._status||(this._status=DG.DomUtil.create("div","soundscreen-ui-status",this._container)),this._input&&(DG.DomEvent.on(this._input,this._events(),this),this._input.focus())},onRemove:function(){this._bforeRemove(),this._lastOut="",DG.DomEvent.off(this._input,this._events(),this),DG.DomUtil.remove(this._container),this.tts.disable()},message:function(txt,delay){txt!=this._lastOut||this._input.title.endsWith("𝄇")||(txt=this._lastOut+"𝄇"),delay?setTimeout(this.message.bind(this,txt),1e3):this._input.setAttribute("title",txt)},repeatMessage:function(){var txt=this._lastOut.replace(/𝄇/,""),prolog=this.locale.t("last_message");this.out(txt.startsWith(prolog)?txt:prolog+" "+txt)},out:function(msg,priority){msg=msg?msg.toString():this._lastOut,this.tts.say(msg,priority)||this.message(msg,priority),priority||(this._lastOut=msg,this._display.innerHTML=msg)},status:function(txt){this._status.innerHTML=this.locale.t("status")+": "+txt},pause:function(){this._blocked=!0},resume:function(){this._blocked=!1}}),DG.Soundscreen.keyboard=DG.Soundscreen.UI.extend({_pressedKeys:{},_keyMap:{13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete"},_onkeyup:function(e){this._pressedKeys[e.keyCode]=!1,39==e.keyCode&&(e.target.selectionStart=e.target.selectionEnd=0)},_onfocus:function(e){e.stopPropagation(),this.out()},_onkeydown:function(e){if(e.keyCode&&!this._pressedKeys[e.keyCode]){this._pressedKeys[e.keyCode]=!0;var key=this._keyMap[e.keyCode]||(1===e.key.length?String.fromCharCode(e.keyCode):e.key),mode=new DG.Soundscreen.keyboard.ModeMap(e);if(!key||mode[key])return void this.tts.cancel();var data={command:mode+key,key:key,code:e.keyCode,mode:mode,original:e};this.onInput(data)}},_setup:function(){this._BrowserTouch=DG.Browser.touch,DG.Browser.touch=!1;var label=DG.DomUtil.create("label","soundscreen-ui-labelinput",this._container);label.innerHTML="Soundscreen:",this._input=DG.DomUtil.create("input","soundscreen-ui-keyboardinput",this._container),this._input.setAttribute("readonly",!0),this._input.value="..",DG.DomEvent.on(this._container,"click",this._prevent)},_beforeRemove:function(){DG.Browser.touch=this._BrowserTouch,DG.DomEvent.off(this._container,"click",this._prevent)},_prevent:function(e){return e.preventDefault(),e.stopPropagation(),!1},_events:function(){return{keyup:this._onkeyup,keydown:this._onkeydown,contextmenu:this._prevent,focus:this._onfocus}}}),DG.Soundscreen.keyboard.ModeMap=function(e){this.Ctrl=e.ctrlKey,this.Alt=e.altKey,this.Shift=e.shiftKey,this.Meta=e.metaKey},Object.defineProperty(DG.Soundscreen.keyboard.ModeMap.prototype,"toString",{value:function(){var res="";for(var key in this)res+=this[key]?key:"";return res},innumerable:!1}),DG.Soundscreen.Position=DG.Marker.extend({_zoomAnimated:!1,set:function(value){return this.setLatLng(value)},get:function(format){if(!format)return this._latlng.clone();var position=[this._latlng.lat,this._latlng.lng];switch(format){case"array":return position;case"string":return position.join(",");case"geoquery":return position.reverse().join(",");default:return this._latlng.clone()}},title:function(message){this._icon.title=message},toCenter:function(){return this._next=this._map.getCenter(),this.setLatLng(this._map.getCenter())},centerBy:function(){return this._next=this.get(),this._map.setView(this.get(),this._map.getZoom(),{animate:!1})},checkBounds:function(latlng){return this._map.getBounds().contains(latlng)},move:function(dir,step,noRestrict){if(this._next=this.get().toSide(dir,step),!this.checkBounds(this._next)){if(!noRestrict)return this.fire("restrict",{latlng:this._next}),this._next=this.get(),!1;this.moveMap(dir)}return this.set(this._next)},moveMap:function(dir){var step,b=this._map.getBounds();step=b.getNorthWest().distanceTo("Left"==dir||"Right"==dir?b.getNorthEast():b.getSouthWest());var newCenter=this._map.getCenter().toSide(dir,step);this._map.setView(newCenter,this._map.getZoom(),{animate:!1})},getEvents:function(){return{zoom:this.update,viewreset:this.update,zoomend:this.visibleControl,moveend:this.visibleControl}},visibleControl:function(e){"moveend"!=e.type||this.checkBounds(this._next)||this.toCenter(),"zoomend"!=e.type||this.checkBounds(this.get())||this._zoom!==this._map.getZoom()&&this.centerBy(),this._zoom=this._map.getZoom()},click:function(){this._map.fire("click",{latlng:this.get()})},onAdd:function(){DG.Marker.prototype.onAdd.apply(this,arguments),this._next=this.get(),this._zoom=this._mapToAdd.getZoom(),this.on("click",this.click,this)},onRemove:function(){DG.Marker.prototype.onRemove.apply(this,arguments),this.off("click",this.click,this)}}),DG.Soundscreen.Mobile=DG.Soundscreen.UI.extend({_onfocus:function(e){e.stopPropagation(),this.out()},_onkeydown:function(e){if(e.keyCode&&!this._pressedKeys[e.keyCode]){this._pressedKeys[e.keyCode]=!0;var key=this._keyMap[e.keyCode]||(1===e.key.length?String.fromCharCode(e.keyCode):e.key),mode=new DG.Soundscreen.keyboard.ModeMap(e);if(!key||mode[key])return void this.tts.cancel();var data={command:mode+key,key:key,code:e.keyCode,mode:mode,original:e};this.onInput(data)}},_setup:function(){this._input=DG.DomUtil.create("div","soundscreen-ui-tuchinput",this._container),this._input.innerHTML="under construction...",DG.DomEvent.on(this._container,"click",this._prevent)},_beforeRemove:function(){DG.DomEvent.off(this._container,"click",this._prevent)},_prevent:function(e){return e.preventDefault(),e.stopPropagation(),!1},_events:function(){return{contextmenu:this._prevent,click:this._onfocus}}}),DG.Soundscreen.Locale.Dictionary.en=DG.extend({yes:"yes",no:"no",status:"status",map_view:"map view",list_view:"list view",map_bound:"map bound",step:"step ",zoom:"zoom ",map_width:"map width ",map_hight:"map hight ",distance:"distance",azimuth:"azimuth",North:"North",Northeast:"Northeast",East:"East",Southeast:"Southeast",South:"South",Southwest:"Southwest",West:"West",Northwest:"Northwest",to_the:"to the ",again:"again",from:"from",last_message:"last message",postal_code:"postal code",n_m:["{n} meter","{n} meters","{n} meters"],n_km:["{n} kilometer","{n} kilometers","{n} kilometers"],n_g:["{n} degree","{n} degrees","{n} degrees"],n_h:["{n} hour","{n} hours","{n} hours"],n_item:["{n} item","{n} items","{n} items"],n_floor:["{n} floor","{n} floors","{n} floors"]},DG.Dictionary.en),DG.Soundscreen.Locale.Dictionary.ru=DG.extend({"true":"да","false":"нет",not_found:"ничего не найдено",no_data:"нет данных",noname:"без названия",name:"название",enable:"включить",enabled:"включено",disable:"отключить",disabled:"недоступно",checked:"отмечено",under_cursor:"под курсором",project_leave:"Вы покинули проект ",project_change:"Территория проекта ",position:"позиция",status:"статус",settings:"настройки",environs:"объекты вокруг",organisation:"Организации в здании ",attraction:"ориентиры",building:"здания",street:"улицы",map_view:"просмотр карты",list_view:"просмотр списка",menu:"меню",choise_value:"выбор значения",geodata:"геоданные",azimuth_format:"формат азимута",clock:"часы",degrees:"градусы",windrose:"стороны света",include_in_request:"включать в запрос",sort_order:"порядок сортировки",pitch:"высота тона",rate:"скорость",volume:"громкость",tts:"синтез речи",map_bound:"граница карты",step:"шаг ",zoom:"зум ",zoomIn:"приблизить ",zoomOut:"отдалить ",toCenter:"позицию в центр карты ",centerBy:"центр карты к позиции ",map_width:"ширина карты ",map_hight:"высота карты ",distance:"дистанция",azimuth:"азимут",North:"север",Northeast:"северо-восток",East:"восток",Southeast:"юго-восток",South:"юг",Southwest:"юго-запад",West:"запад",Northwest:"северо-запад",to_the:"на ",again:"снова",from:"из",last_message:"крайнее сообщение",postal_code:"почтовый индекс",n_m:["{n} метр","{n} метра","{n} метров"],n_km:["{n} километр","{n} километра","{n} километров"],n_g:["{n} градус","{n} градуса","{n} градусов"],n_h:["{n} час","{n} часа","{n} часов"],n_item:["{n} элемент","{n} элемента","{n} элементов"],n_floor:["{n} этаж","{n} этажа","{n} этажей"]},DG.Dictionary.ru),DG.Control.Soundscreen=DG.RoundControl.extend({options:{position:"topright"},statics:{Dictionary:{}},initialize:function(options){DG.setOptions(this,options||{}),DG.extend(this,{_active:!1,_geoclickerNeedRestore:!1}).on(this._controlEvents,this)},_controlEvents:{add:function(){!this._map.soundscreen},click:function(){if(this._active)this._map.soundscreen.disable(),this.setState("");else{try{this._map.soundscreen.enable()}catch(err){if(this._map.soundscreen.options.debug){console.error(err.message);var content="<h3>Error</h3>"+DG.Soundscreen.tools.objectMap(err,{own:!0}).join("<br>");this._map.openPopup(content,this._map.getCenter())}}this.setState("active")}this._active=!this._active,this._renderTranslation()},remove:function(){this.off(this._controlEvents,this),this._active&&(this._map.soundscreen.disable(),this._active=!1),this._map.soundscreen=null}},_renderTranslation:function(){this._link.innerHTML=this.t(this._active?"off":"on")}}),DG.Map.mergeOptions({soundscreen:!1}),DG.Map.addInitHook(function(){if(this.options.soundscreen){try{this.soundscreen=new DG.Soundscreen(this,this.options.soundscreen),this._handlers.push(this.soundscreen)}catch(err){return void(this.options.soundscreen.debug&&console.error(err.message,err.fileName,err.lineNumber,err.columnNumber))}this.soundscreenControl=new DG.Control.Soundscreen(this.options.soundscreen.control),this.addControl(this.soundscreenControl)}}),DG.Control.Soundscreen.Dictionary.en={on:"Run screenreaders support",off:"Stop screenreaders support",browser_not_supported:"browser not supported"},DG.Control.Soundscreen.Dictionary.ru={on:"Включить поддержку скринридера",off:"Отключить поддержку скринридера",browser_not_supported:"В этом браузере не работает"};